#!/usr/bin/env python3

import numpy as np
from QAM.ModulatorQAM import ModulatorQAM

__INPUT_BITS = [1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1,
                1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1]


# import numpy as np
# import sys
# np.set_printoptions(threshold=sys.maxsize)
# txData = np.random.randint(-32768, 32767, 1024, dtype=np.int16)
# print(np.array2string(txData, separator=', '))
__RANDOM_1024_INT16 = np.array([29072, -24434,   4638,  28487, -14095,  17203, -23269,  -4852,  -1954,
                                25930,   8897,  18405,   8162,  18745,  30051,  -2752,  23200,  21574,
                                29056, -27507, -18260, -21646,  14908,  21501, -11496, -28817, -21639,
                                2728,  16180,   8266, -22329, -16491,  32303,  -3699,   -582,  -8039,
                                20428,  31562, -20114,   1101, -23913,  20374, -17272, -28428,  18866,
                                25000, -29627, -27511,   1149,  10853, -17732,   9473, -14089, -26045,
                                -11206,  -6913,  -6201,  32230,  28468,  25188, -23307,   1425,  32234,
                                -16342,  18551,  26512,  19869, -20718, -22951,   2831,   1424, -17147,
                                -6457,  11977,  22061, -25505,  20207, -27676,  30126,   -342,  32577,
                                -3852, -23518,  -7138,  24325,  18496, -28092,  10002, -12968,   2054,
                                5932, -24911,   -960,  32249,    624, -18632,  27292,  -8212, -28001,
                                19952,  31755,  -8248,  12017,  28008,  15699, -22747, -22880,  -6527,
                                17897, -11985,  26664, -21014,   2413,  11592,  19561,   8389,  29282,
                                -11464,  30009,  31282, -19733,  20974,  29013,  28842, -13799, -12083,
                                -13947, -30090, -17212,  29087,  26440, -15221,  12396, -25118, -11260,
                                12351, -23808, -30115, -10442,  -1651,   2888,  -8206,  12350,  30422,
                                13928, -22488,  -1246, -17467, -10328,   7717,  -2794,  26653, -25896,
                                8546, -11745,   7350, -12368,  -2405,  32020,   -738, -12607,  19477,
                                18139, -13717,  -8175,  31999, -26577,  14532,  27101,   4590,   2532,
                                -12287, -11244,  23128, -22037,  -1790,  27639, -28290,  25946, -22632,
                                14703,  17069, -18652,  29406,  10637,  13426, -23088, -28703,   1960,
                                14541,  -6010,  16034, -25997,  27093,   8762,   1154, -29274, -17762,
                                -26456,  23096,  15793,  14382,  13681,  23512, -12038, -30860,  -1867,
                                27583, -13185, -24006,  13683, -17978, -32256,  24397,  17167, -31671,
                                15796, -20788,   5976,  18036,  14326,  21470, -13249,  20183,  19796,
                                23842, -20208, -21497,  23158,  24104, -27431,  16721, -13708, -32294,
                                25420,  20076, -32469,  -4174,  22428, -26960, -31187, -15060, -24497,
                                21529,   5620,  26773,  -7203,  19783,  27469,  32681, -30773,    493,
                                12684, -21972,  25793, -28810,  -7835,  -7954,  30511,   2841, -14747,
                                6183, -21209, -25350,  30909, -24490,   9011,  32635, -30430, -25833,
                                4744, -18729,   -338,  -4767,  -2842, -26141,  32032,  25227,  22902,
                                -28093,  12247,  13936, -12449, -18869, -12756,  -3734,  -9507, -14983,
                                29544, -31849,   7125, -29142,   6815,  14641,  -3665,  -9352, -10023,
                                32554,  31498, -28598,  23534,   8306,   5704,  -5701,  -3796,  21167,
                                -5227,  13599, -10670, -21410, -12135,  24229,  -9687, -21158,  18245,
                                -21658,  -7821,  -1465, -12019,  24442, -29507, -14097,  -9163,  -3465,
                                -7759,  -1994, -19887,  15722,  28430, -32738, -12824, -26096,  10977,
                                6828,  26820,  -8522, -28722,  -8779, -15668, -10148,  11606,  -4734,
                                18751, -15928, -29043,   7312,  -7607,  25588, -10087,   9485,  11934,
                                -3855,   6731, -24394,  -3638,  -4850, -30574,  16656,  26220,  28522,
                                7685,   7657,  31348,  10720,  -2069,   4716,  -7632,   3532,  -9075,
                                -19791,  11926,  -3738,   8582,  12950, -13874,  16908, -27338,  -5252,
                                16851,  25873, -30580, -26053, -22628,  12244,  32424,  11073, -14057,
                                17546, -11874,  31730,  31514,   -509,  -8671,   2571,  -4172, -18740,
                                -11024,  -5550,  -1002,   8853,  23108,  23681,  -4488,  31738,  -6338,
                                20042,  20398,   5225, -11949,  16407,  13869, -10217, -27878,  -1537,
                                18110, -19968,  28974,  12031, -29680,   7171, -24930,  11070, -31295,
                                -26613, -23380, -20538, -31528, -28180, -16124, -10507,  21116,   4509,
                                -21951,   4104,  24855,  25685,  13738,  -7581,  24383,   3072, -22158,
                                -29511, -12502,  30012,  27681,  -1585, -11364,  10113,   5400,  10336,
                                -16941,  32485,  -5602, -23441,  23252,  17051,  -1309, -20551, -22753,
                                -28159, -11528,  30576,  23476, -16229,  28069,   7075,   8057, -27343,
                                21639,   9893,   2118,  31528,  27252,  30571,  -2944,   5997,  24390,
                                15416,   7568, -28977, -14298,   8641, -24029,  -4246,  -7610,  -9360,
                                -14170,  22886,  28728,  27359, -27255,  -8285,  25658,  16421,  29782,
                                -15848,      3,  -1639,  29862, -27141,  22673, -21853, -12918, -13085,
                                19707, -18338,  20233,  -2068, -12748, -21167, -14530, -27907,  23199,
                                -31901,  30304,  10164, -16481, -15655, -18566,  32501, -14479,  23562,
                                -25505,   -449,   5922, -13547,   3320, -14731, -19370,  31705,  20517,
                                424,   -300,  18693,   -883, -28085,  29512, -14790, -22227,   6789,
                                2834,   2050, -21930, -11104,  14784, -30412,  14217,  30526, -15808,
                                16670,  -5770,  26115, -11317,  17236,  15236,   5258, -29461, -30462,
                                24739, -26183, -18766,  14475, -19415,   9838,  20086, -17819,  -9278,
                                27869,  13820,  31833, -21183, -24027,    709, -15500,  29370, -17527,
                                -23554,  28634,   8595,  15361,  16850, -29832,   3663,   -372, -26905,
                                6078,  15336,  16209, -17961,  19066,  -5976,  -3329, -16265, -28389,
                                -19293, -17219,  15370,   -851,   1509,  26810, -23511,  21430,  29485,
                                -1217, -12115,  -5844, -12713,   1600, -23444,   2640,  -9749, -30874,
                                28792,  31276,   9337, -22348,  -3940,  15234,    356,  -8561,  28196,
                                -25707, -15650,  -2766,  -3188, -30133, -16076,  17254,  -5538,   7464,
                                25974, -22963, -12253,  -3929,  -3900,  -9371, -15103,  -2310,  31236,
                                -14810,  26008,  16450,  27052,  17011, -29059,  14122, -10182, -10180,
                                -16778,  13369,   1921, -17914, -13725,   2832,  16781, -29547, -19584,
                                4136,  13403,  28910,  21935,  14538,  -3294,  19015,   4901,  -9264,
                                -28561,   2343,  -7548, -18097,   9352, -15525,  13852,  30802,  23815,
                                -17422,   4154,   5359,   6347,   1288,   9497,  15545,  17305,  -1174,
                                11905, -32062,   6187, -20680,   6967, -25314, -30777,  16088, -11873,
                                -9101, -26196,   9017, -29315,  19952, -31818, -30884, -18608,  -7583,
                                -3808,  21755,  19424,  25149,  11825,  24970, -12744, -21592,   2410,
                                126,   -147,  27552, -23126,  17741,  22051, -29436,   5869,  -1612,
                                19238,  13991,  18294,  16016, -32568, -17815, -15170,    532,  -9360,
                                -28021,  -2195,  23883,  24482, -32721,  -1129,  20911, -11260,  26505,
                                7747, -12677,  20159,  -6300,   1241,   5482,   2277,  21981,  -5030,
                                27022, -20114, -19464, -21412,  23418,  -3156, -15105,   2849,  22628,
                                -18110, -31152, -17614,  18299,   -692, -14173,  20986,   9418,   6071,
                                26023, -20751,  20287,  13657,  10885,  30742,  -8690,   9972,  14064,
                                -32284,  19009,  26185,  15009,   1683, -16512, -20958,  10719,   1661,
                                -15103,  31036,    835,  20906,  22943, -23319,  15569,  24085,  11191,
                                -7068,  -9173,  12256,  30675, -18702, -32438,  32574,   7840,  21038,
                                -24453, -32440, -19591, -12469, -18904,  -7387,  30840,  26403, -13165,
                                -21936,   -125,   1486,  23707, -15667,  -2764, -12501,   4039,  16077,
                                28497, -10538,  13998,  32499, -22295,  30359, -31127,   7003,   3649,
                                -22104,  -2649,  -5434,  -2496,  -8712,  14656,  14561, -18849,  -5255,
                                -21833, -25416, -27289, -24230,  32065, -13038,  27628,  -7433, -15245,
                                -9360,   5070, -22569,  30511, -11400,  -5102,  19337,  29764,  -9161,
                                7085,  29437,  10895, -19492, -19874,  17314,  21740,  21298,   8085,
                                -19965,  27060,  -2097,     41,  28019,   8210,  27927, -32173,  17239,
                                16995,  13239, -23290, -14434,  23996, -22756, -15960, -13887,  -9266,
                                21783,  -5111,   1451,  19345,    824,  -8355,   4045,   8012,  21388,
                                -2184, -10775,  27068,  29879, -15046,  23156,   3337,  22809,  32410,
                                8671,  29872,  -4165, -16605,  18444, -17100,  17227,  26776,  -5276,
                                -15834,    940,  -6328,  24323,  -5282, -29390, -25672,  14085,  23571,
                                8055, -13425,   1906,  23839, -12328, -32726,  -5252,  11362,  17909,
                                -3529,  28217, -31108,  -6926, -22851, -18737,  -7111, -21226, -28618,
                                -28826,  21240,  32144, -20144,   8896,  32610,   1668, -32361, -21748,
                                9199,  -5039, -20965, -18536, -21253,  21359,  27787,  14652, -14188,
                                -9965,  -3775, -25793,  20604,  21873, -26799,  20597,  10510, -20534,
                                -24845,  17927, -27648,  32369,  29352, -13205,  -7942,   3547, -26316,
                                -22584, -14315,  32550,  28348, -22654, -31952, -10789,  29281,  26812,
                                -24011,  15693,  31882, -29034,  -2843,  19322, -10313,   3634,  27896,
                                -18421, -18481,   4671,   1968,  30931,  27979,  29570,  13059,  12887,
                                -9246,  -6333,  32213,  27542,  27281,  26635,   9663,  22622, -21228,
                                -14121, -25350, -26981,  16511,   9589,   2790, -30897, -28681,  29147,
                                25386, -19564, -22315,  -1190, -24039,  19363,  27956], dtype=np.int16)


# TODO: optimize IF frequency and sampleRate
__CARRIER_FREQ = 10e5


def __unpackbits(x, num_bits):
    """
    https://stackoverflow.com/questions/18296035/how-to-extract-the-bits-of-larger-numeric-numpy-data-types

    """
    xshape = list(x.shape)
    x = x.reshape([-1, 1])
    to_and = 2**np.arange(num_bits).reshape([1, num_bits])
    return (x & to_and).astype(bool).astype(int).reshape(xshape + [num_bits])


def __qam16_stationary_data():
    mod0 = ModulatorQAM(carrierFreq=__CARRIER_FREQ,
                       upsamplingFactor=8, sampleRate=20e6,fi=0 )
    result0 = mod0.modulateQAM16(__INPUT_BITS, isSignalUpconverted=True, debug=True)

def __qam16_random_data():
    # unpackedRandomBits = __unpackbits(__RANDOM_1024_INT16, 16)
    mod1 = ModulatorQAM(carrierFreq=__CARRIER_FREQ,
                    upsamplingFactor=8, sampleRate=20e6,fi=0 )
    result1 = mod1.modulateQAM16(__RANDOM_1024_INT16.tobytes(), isSignalUpconverted=True, debug=True)
  



# python3 -m flamegraph -o QAM_UT/perf.log QAM_UT/ModulatorQAM_UT.py
# ~/Download/FlameGraph/flamegraph.pl --title "QAM16 modulation" QAM_UT/perf.log > perf.svg
def main():
    __qam16_random_data()
    
if __name__== "__main__":
  main()